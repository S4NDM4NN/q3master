<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RTCW / ET Master Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body { background:#111;color:#ddd;font-family:monospace;padding:2rem; }
    .q3name span { white-space: pre; }
    .card { background:#1b1b1b;border:1px solid #333;margin-bottom:1rem; }
    .card-header { background:#222;padding:1rem; }
    .card-body { padding:1rem 1.25rem; }
    .info-grid { display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:.5rem;margin-top:1rem; }
    .info-grid div { font-size:.95rem;color:#eee; }
    .info-grid .info-label { display:block;font-size:.75rem;color:#aaa;margin-bottom:.2rem; }
    .player-grid { display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:.5rem;margin-top:1rem;color:#eee;word-break:break-word; }
    .collapse.show { padding-top:1rem; }
    .address { font-size:.9rem;color:#f58; }
    .player-count { font-weight:bold;color:#eee; }
    .status-dot { width:12px;height:12px;border-radius:50%;display:inline-block;margin-right:6px; }
    .online-dot { background:#4caf50; }
    .offline-dot { background:#f44336; }
    .server-status { font-size:.85rem;color:#ccc; }
    .clipboard-icon { cursor:pointer;font-size:1rem;color:#ccc;transition:color .2s; }
    .clipboard-icon:hover { color:#fff; }
    .info-toggle { cursor:pointer;color:#66d9ef;font-size:1.2rem;transition:color .2s ease; }
    .info-toggle:hover { color:#0dcaf0; }
    .toolbar { display:flex;gap:1rem;flex-wrap:wrap;align-items:center;margin-bottom:1rem; }
    .counts { opacity:.8 }
  </style>
</head>
<body>
  <h1 class="mb-3">
    RTCW / ET Master Viewer<br>
    <span id="server-counts" class="fs-6 text-light-emphasis counts"></span>
  </h1>

  <div class="toolbar">
    <input type="text" id="server-filter" class="form-control bg-dark text-light border-secondary" placeholder="Filter servers... (hostname, map, mod, ip, version)" style="max-width:420px;">
    <div class="form-check">
      <input class="form-check-input" type="checkbox" id="showOfflineToggle">
      <label class="form-check-label text-light" for="showOfflineToggle">Show Offline</label>
    </div>
    <div class="btn-group" role="group" id="protocol-filter">
      <input type="radio" class="btn-check" name="protocol" id="filter-all" value="all" autocomplete="off" checked>
      <label class="btn btn-outline-light" for="filter-all">All</label>

      <input type="radio" class="btn-check" name="protocol" id="filter-57" value="57" autocomplete="off">
      <label class="btn btn-outline-light" for="filter-57">RTCW 1.0</label>

      <input type="radio" class="btn-check" name="protocol" id="filter-60" value="60" autocomplete="off">
      <label class="btn btn-outline-light" for="filter-60">RTCW 1.4</label>

      <input type="radio" class="btn-check" name="protocol" id="filter-84" value="84" autocomplete="off">
      <label class="btn btn-outline-light" for="filter-84">ET 2.60b</label>
    </div>
  </div>

  <div id="server-container"></div>

  <script>
    function debounce(fn, wait=150){
      let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); };
    }

    // Q3/ET color parsing
    const colorMap = {
      '0':'#FFFFFF','1':'#FF0000','2':'#00FF00','3':'#FFFF00',
      '4':'#0000FF','5':'#00FFFF','6':'#FF00FF','7':'#FFFFFF',
      '8':'#808080','9':'#000000',
      'a':'#FF7F00','b':'#7FFF00','c':'#007FFF','d':'#7F00FF','e':'#FF007F','f':'#00FF7F',
      'g':'#FFAA00','h':'#AAFF00','i':'#00AAFF','j':'#AA00FF','k':'#FF00AA','l':'#00FFAA',
      'm':'#DDDDDD','n':'#AAAAAA','o':'#777777','p':'#444444','q':'#222222',
      'r':'#FFAACC','s':'#AAFFCC','t':'#CCAAFF','u':'#FFCCAA','v':'#CCFFAA',
      'w':'#AACCAA','x':'#AACCFF','y':'#CCAACC','z':'#AACCBB',
      'A':'#FF7F00','B':'#7FFF00','C':'#007FFF','D':'#7F00FF','E':'#FF007F','F':'#00FF7F',
      'G':'#FFAA00','H':'#AAFF00','I':'#00AAFF','J':'#AA00FF','K':'#FF00AA','L':'#00FFAA',
      'M':'#DDDDDD','N':'#AAAAAA','O':'#777777','P':'#444444','Q':'#222222',
      'R':'#FFAACC','S':'#AAFFCC','T':'#CCAAFF','U':'#FFCCAA','V':'#CCFFAA',
      'W':'#AACCAA','X':'#AACCFF','Y':'#CCAACC','Z':'#AACCBB'
    };
    function parseNameColors(name) {
      let out='', color='white';
      for (let i=0;i<name.length;i++){
        if (name[i]==='^' && i+1<name.length && colorMap.hasOwnProperty(name[i+1])) {
          color=colorMap[name[++i]]; continue;
        }
        out += `<span style="color:${color}">${name[i]}</span>`;
      }
      return out || '&nbsp;';
    }

    function getProtocolLabel(p){
      switch(p){case 57:return'RTCW 1.0';case 60:return'RTCW 1.4';case 84:return'ET 2.60b';default:return'Unknown';}
    }

    function formatLastSeen(ts){
      const d=new Date(ts); if (isNaN(d)) return 'â€”';
      return d.toLocaleString(undefined,{hour:'2-digit',minute:'2-digit',month:'short',day:'numeric'});
    }

    // Treat entries with no successful poll as "new" (hide them)
    function isNewServer(s){
      if (s.state) return s.state === 'new';
      // fallback for current API: Go zero time => "0001-01-01..."
      const d = new Date(s.last_seen);
      return isNaN(d) || d.getFullYear() < 2000;
    }

    const refreshServers = (function(){
      let lastData = []; // cache last payload to avoid flicker when just filtering

      function render(data){
        const container = $("#server-container").empty();

        const showOffline = $("#showOfflineToggle").is(":checked");
        const selectedProtocol = $("input[name='protocol']:checked").val();
        const q = ($('#server-filter').val()||'').toLowerCase();

        // Never show "new"
        let items = data.filter(s => !isNewServer(s));

        // Apply protocol + offline + search filters
        items = items
          .filter(s => selectedProtocol === "all" || String(s.protocol) === selectedProtocol)
          .filter(s => showOffline || s.online === true)
          .filter(s =>
            (s.hostname||'').toLowerCase().includes(q) ||
            (s.map||'').toLowerCase().includes(q) ||
            (s.mod||'').toLowerCase().includes(q) ||
            (s.gametype||'').toLowerCase().includes(q) ||
            (s.address||'').toLowerCase().includes(q) ||
            (s.version||'').toLowerCase().includes(q)
          );

        // Counts reflect the currently visible list
        const onlineCount  = items.filter(s => s.online === true).length;
        const offlineCount = items.filter(s => s.online === false).length;
        $("#server-counts").text(`ðŸŸ¢ ${onlineCount} / ðŸ”´ ${offlineCount}`);

        // Sort + render as before
        items.sort((a,b)=>{
          if (a.online !== b.online) return a.online ? -1 : 1;
          if ((b.player_count|0)!==(a.player_count|0)) return (b.player_count|0)-(a.player_count|0);
          return (a.address||'').localeCompare(b.address||'');
        });

        items.forEach((server, idx)=>{
          const realPlayers = (server.players||[]).map(p=>`<div class="q3name">${parseNameColors(p)}</div>`).join('');
          const botPlayers  = (server.bots||[]).map(p=>`<div class="q3name"><i class="bi bi-robot me-1"></i>${parseNameColors(p)}</div>`).join('');
          const hasBots = (server.bots||[]).length>0;
          const hostname = parseNameColors(server.hostname||'Unnamed Server');
          const collapseId = `c-${idx}`;
          const dot = server.online ? 'online-dot':'offline-dot';
          const label = server.online ? 'Online':'Offline';

          container.append(`
            <div class="server-card"
                data-hostname="${(server.hostname||'').toLowerCase()}"
                data-map="${(server.map||'').toLowerCase()}"
                data-mod="${(server.mod||'').toLowerCase()}"
                data-gametype="${(server.gametype||'').toLowerCase()}"
                data-address="${(server.address||'').toLowerCase()}"
                data-version="${(server.version||'').toLowerCase()}">
              <div class="card">
                <div class="card-header d-flex align-items-start justify-content-between">
                  <div class="flex-grow-1">
                    <div class="q3name fs-5">
                      <span class="badge bg-secondary me-2">${getProtocolLabel(server.protocol)}</span>
                      ${hostname}
                    </div>
                    <div class="address d-flex align-items-center">
                      <code id="ip-${idx}" class="me-2">${server.address}</code>
                      <i class="bi bi-clipboard clipboard-icon" data-ip="${server.address}" title="Copy to clipboard"></i>
                    </div>
                    <div class="d-flex gap-4 mt-2">
                      <div><span class="text-light-emphasis">Mod:</span> <span class="text-info">${server.mod||'unknown'}</span></div>
                      <div><span class="text-light-emphasis">Map:</span> <span class="text-warning">${server.map||'unknown'}</span></div>
                    </div>
                  </div>

                  <div class="text-end ms-3" style="min-width: 160px;">
                    <div class="server-status mb-1">
                      <span class="status-dot ${dot}"></span>${label}
                    </div>
                    <div class="player-count">
                      ${(server.player_count??0)}/${server.max_players??0} players
                      ${hasBots ? ` <i class="bi bi-robot" title="Bots"></i> ${server.bot_count??0}` : ``}
                    </div>
                    <div class="text-end" style="font-size:.85rem;color:${server.online?'#ccc':'#f0ad4e'};">
                      Last seen: ${formatLastSeen(server.last_seen)}
                    </div>
                    <div class="text-end mt-2">
                      <i class="bi bi-search info-toggle" data-bs-toggle="collapse" data-bs-target="#${collapseId}" role="button" title="Show details"></i>
                    </div>
                  </div>
                </div>

                <div id="${collapseId}" class="collapse card-body">
                  <div class="info-grid">
                    <div><span class="info-label">Gametype</span>${server.gametype||'<em>unknown</em>'}</div>
                    <div><span class="info-label">Version</span>${server.version||'<em>unknown</em>'}</div>
                  </div>
                  <h6 class="mt-3 text-light-emphasis fw-bold">Players:</h6>
                  <div class="player-grid">
                    ${realPlayers || '<em>No players online</em>'}
                  </div>
                  ${hasBots ? `
                  <h6 class="mt-3 text-light-emphasis fw-bold">Bots:</h6>
                  <div class="player-grid">${botPlayers}</div>` : ``}
                </div>
              </div>
            </div>
          `);
        });
      }

      // Returned function decides whether to fetch or reuse last data
      return function refresh(shouldFetch=true){
        if ($(".collapse.show").length > 0) return;

        if (shouldFetch) {
          $.getJSON("/api/servers", function(data){
            lastData = data || [];
            render(lastData);
          });
        } else {
          render(lastData);
        }
      };
    })();
    // Clipboard
    $(document).off('click','.clipboard-icon').on('click','.clipboard-icon',function(e){
      e.preventDefault(); e.stopPropagation();
      const ip=$(this).data('ip'), icon=$(this);
      navigator.clipboard.writeText(ip).then(()=>{
        icon.removeClass('bi-clipboard').addClass('bi-clipboard-check');
        setTimeout(()=>icon.removeClass('bi-clipboard-check').addClass('bi-clipboard'), 900);
      });
    });

    // Client-side text filter (works without refetch)
    $('#server-filter').on('input', function(){
      const query = ($(this).val()||'').toLowerCase();
      $('.server-card').each(function(){
        const $c=$(this);
        const m =
          String($c.data('hostname')||'').includes(query) ||
          String($c.data('map')||'').includes(query) ||
          String($c.data('mod')||'').includes(query) ||
          String($c.data('gametype')||'').includes(query) ||
          String($c.data('address')||'').includes(query) ||
          String($c.data('version')||'').includes(query);
        $c.toggle(m);
      });
    });

    const refreshNow = () => refreshServers(false);
    const refreshDebounced = debounce(() => refreshServers(false), 150);

    // protocol + showOffline: instant re-render
    $('#protocol-filter input').off('change').on('change', refreshNow);
    $('#showOfflineToggle').off('change').on('change', refreshNow);

    // search box: debounced re-render
    $('#server-filter').off('input').on('input', refreshDebounced);

    setInterval(refreshServers, 10000);
    refreshServers();
  </script>
</body>
</html>
